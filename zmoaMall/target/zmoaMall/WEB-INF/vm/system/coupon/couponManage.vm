#set($layout = "layout/empty.vm")
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>优惠券管理</title>
    <link rel="stylesheet" type="text/css" href="/js/jeasyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="/js/jeasyui/themes/color.css">
    <link rel="stylesheet" type="text/css" href="/js/jeasyui/themes/default/easyui.css">

    <script type="text/javascript" src="/js/jeasyui/jquery.min.js"></script>
    <script type="text/javascript" src="/js/jeasyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/js/jeasyui/plugins/datagrid-filter.js"></script>
    <script type="text/javascript" src="/js/jeasyui/plugins/datagrid-detailview.js"></script>
    <script type="text/javascript" src="/js/jeasyui/locale/easyui-lang-zh_CN.js"></script>
</head>
<body>

<table id="tg" class="easyui-datagrid" data-options="
        url: '/coupon/getCouponSources.action',
        toolbar:'#tb',
        fitColumns:true,
        title:'优惠券管理（您可以进行添加，编辑，删除优惠券操作）',
        border:false,
        fit:true,
        rownumbers: true,
        pagination: true,
        pageSize:20,
        singleSelect:true,
        idField: 'id',
        treeField: 'name'
    ">

    <thead>
    <tr>
        <th data-options="field:'ck',checkbox:true"></th>
        <th data-options="field:'id',align:'left'" width="5%">优惠券Id</th>
        <th data-options="field:'name',align:'left'" width="15%">优惠券名称</th>
        <th data-options="field:'type',align:'left',formatter:typeFormatter" width="10%">优惠券类型</th>
        <th data-options="field:'activityName',align:'left'" width="13%">所属活动</th>
        <th data-options="field:'faceValue',align:'left'" width="5%">面值</th>
        <th data-options="field:'minimumValue',align:'left'" width="5%">最低消费金额</th>
        <th data-options="field:'totalNumber',align:'left'" width="5%">总数量</th>
        <th data-options="field:'sendNumber',align:'left'" width="5%">已发放</th>
        <th data-options="field:'exchangeNumber',align:'left'" width="5%">已兑换</th>
        <th data-options="field:'restNumber',align:'left'" width="5%">剩余</th>
        <th data-options="field:'needPoint',align:'left'" width="5%">兑换所需</th>
        <th data-options="field:'couponRuleListString',align:'left'" width="15%">优惠券规则</th>
        <th data-options="field:'status',align:'left',formatter:statusFormatter" width="5%">状态</th>
    </tr>
    </thead>
</table>

<!-- toolbar -->
<div id="tb" style="padding:2px 5px;">
    <a href="#" class="easyui-menubutton" style="width:120px" data-options="menu:'#mm',iconCls:'icon-add'">添加优惠券</a>
    #*<a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-add'" onclick="addCouponRuleDlg();">添加优惠券使用规则</a>*#
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-reload'" onclick="updateCouponStatus(1);">启用优惠券</a>
    <a href="#" title="优惠券冻结后将不能发放" class="easyui-linkbutton easyui-tooltip" data-options="iconCls:'icon-remove'" onclick="updateCouponStatus(0);">冻结优惠券</a>
    <a href="#" title="优惠券禁用后将不能使用" class="easyui-linkbutton easyui-tooltip" data-options="iconCls:'icon-remove'" onclick="updateCouponStatus(-1);">禁用优惠券</a>
    <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" onclick="deleteCouponSource();">删除优惠券</a>
    &nbsp;&nbsp;
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-search" style="width:100px" onclick="searchCode();">筛选</a>
    &nbsp;&nbsp;
    <a href="#" class="easyui-linkbutton" iconCls="icon-redo" onclick="couponSendBatchDlg();">批量发放优惠券</a>
    <a href="#" class="easyui-linkbutton" iconCls="icon-redo" onclick="couponSendUserDlg();">指定用户发放优惠券</a>
</div>

<!-- Menu -->
<div id="mm" style="width:100px;">
    <div onclick="addNormalCouponSourceDlg();">普通优惠券</div>
    #*<div onclick="addExchangeCouponSourceDlg();">兑换优惠券</div>
    <div onclick="addGiveCouponSourceDlg();">赠送优惠券</div>*#
</div>


<!-- 修改对话框 -->
<div id="dlg" class="easyui-dialog" style="width:500px" closed="true" buttons="#dlg-buttons"></div>
<div id="dd" style="width:500px"></div>
<div id="couponRuleDlg" style="width:500px"></div>
<div id="couponSendUserDlg" style="width:500px"></div>
<div id="couponSendBatchDlg" style="width:500px"></div>


<!-- 对话框按钮 -->
<div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="addCouponActivity();" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')" style="width:90px">取消</a>
</div>

<!-- 对话框 -->
<div id="rule-dlg" class="easyui-dialog" style="width:300px" title="添加优惠券规则名称" closed="true" buttons="#rule-dlg-buttons">
    <form id="rule-fm" method="post" novalidate style="margin:0;padding:20px 50px">
        <input name="couponSourceId" value="" type="hidden">
        <div style="margin-bottom:20px;font-size:14px;border-bottom:1px solid #ccc">填写优惠券使用规则名称</div>
        <div style="margin-bottom:10px">
            <input name="name" class="easyui-textbox" style="width:100%" data-options="
                label:'&bull; 规则名称：(例如：金额)',
                required:true,
                labelPosition:'top',
                ">
        </div>
        <div style="margin-bottom:10px">
            <input name="name" class="easyui-textbox" style="width:100%" data-options="
                label:'&bull; 规则编码：(例如：YHQ_GZ_JE)',
                required:true,
                labelPosition:'top',
                ">
        </div>
    </form>
</div>
<!-- 对话框按钮 -->
<div id="rule-dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="addCouponCategory();" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')" style="width:90px">取消</a>
</div>



<script>

    function addCouponRuleDlg() {
        $('#rule-dlg').dialog('open').dialog('center');
    }

    function deleteCouponSource() {
        jQuery.messager.confirm('删除', '优惠券源信息删除后，对应已发放的优惠券也将不能使用！请确定所属活动已结束后方可删除！你确定删除吗？', function(r){
            if (r){
                updateCouponStatus(-2);
            }
        });
    }

    function updateCouponStatus(status) {
        var row = $('#tg').datagrid('getSelected');
        if (row) {
            jQuery.ajax({
                url: "/coupon/updateCouponStatus",
                type: "post",
                data: "couponId="+row.id+"&status=" + status,
                dataType: "json",
                success: function(data){
                    $('#tg').datagrid('reload');
                }
            });
        } else {
            jQuery.messager.show({
                title:'提示！',
                msg:'请先选中一条记录！',
                showType:'show',
                style:{
                    left:'',
                    right:0,
                    top:document.body.scrollTop+document.documentElement.scrollTop,
                    bottom:''
                }
            });
        }
    }

    function typeFormatter(value,row,index){
        if (row.type == 0){
            return '普通优惠券';
        } else if (row.type == 1) {
            return '兑换优惠券';
        } else if (row.type == 2) {
            return '赠送优惠券';
        }
    }

    function dateFormatter(value,row,index){
        return new Date(value).toLocaleString();
    }

    function statusFormatter(value,row,index){
        if (value == -1){
            return '<span style="color:red;">已禁用</span>';
        } else if (value == 0) {
            return '<span style="color:blue;">已冻结</span>';
        } else if (value == 1) {
            return '<span style="color:green;">已启用</span>';
        }
    }

    function couponSendUserDlg() {
        var row = $('#tg').datagrid('getSelected');

        if (row) {
            if (row.status == 0 || row.status == -1) {
                var str = row.status == 0 ? '冻结' : '禁用';
                jQuery.messager.show({
                    title:'提示！',
                    msg:'优惠券已'+str+'，无法发放！',
                    showType:'show',
                    style:{
                        left:'',
                        right:0,
                        top:document.body.scrollTop+document.documentElement.scrollTop,
                        bottom:''
                    }
                });
                return;
            }
            $('#couponSendUserDlg').dialog({
                title: '指定用户发放优惠券',
                width: 700,
                height: 400,
                href: '/coupon/couponSendUserDlg?sourceId='+row.id,
                buttons:[{
                    text:'取消',
                    iconCls:'icon-cancel',
                    handler:function(){
                        $('#couponSendUserDlg').dialog('close');
                    }
                }]
            });
        } else {
            jQuery.messager.show({
                title:'提示！',
                msg:'请先选中一条记录！',
                showType:'show',
                style:{
                    left:'',
                    right:0,
                    top:document.body.scrollTop+document.documentElement.scrollTop,
                    bottom:''
                }
            });
        }
        //$('#dlg').dialog('open').dialog('center').dialog('setTitle','新增活动');
        //$('#fm').form('clear');
    }

    function couponSendBatchDlg() {
        var row = $('#tg').datagrid('getSelected');

        if (row) {
            if (row.status == 0 || row.status == -1) {
                var str = row.status == 0 ? '冻结' : '禁用';
                jQuery.messager.show({
                    title:'提示！',
                    msg:'优惠券已'+str+'，无法发放！',
                    showType:'show',
                    style:{
                        left:'',
                        right:0,
                        top:document.body.scrollTop+document.documentElement.scrollTop,
                        bottom:''
                    }
                });
                return;
            }
            $('#couponSendBatchDlg').dialog({
                title: '优惠券批量发放',
                width: 700,
                height: 400,
                href: '/coupon/couponSendBatchDlg?sourceId='+row.id,
                buttons:[{
                    text:'立即发放',
                    iconCls:'icon-ok',
                    handler:function(){
                        batchAddCoupon();
                    }
                },{
                    text:'取消',
                    iconCls:'icon-cancel',
                    handler:function(){
                        $('#couponSendBatchDlg').dialog('close');
                    }
                }]
            });
        } else {
            jQuery.messager.show({
                title:'提示！',
                msg:'请先选中一条记录！',
                showType:'show',
                style:{
                    left:'',
                    right:0,
                    top:document.body.scrollTop+document.documentElement.scrollTop,
                    bottom:''
                }
            });
        }
        //$('#fm').form('clear');
    }


    function addNormalCouponSourceDlg() {
        //$('#dlg').dialog('open').dialog('center').dialog('setTitle','新增活动');

        $('#dd').dialog({
            title: '增加优惠券',
            width: 700,
            height: 400,
            href: '/coupon/couponActivityAddNormal',
            buttons:[{
                text:'增加',
                iconCls:'icon-ok',
                handler:function(){
                    addCouponSource();
                }
            },{
                text:'取消',
                iconCls:'icon-cancel',
                handler:function(){
                    $('#dlg').dialog('close');
                }
            }]
        });
        //$('#fm').form('clear');
    }

    function couponRuleDlg(couponId) {
        //$('#dlg').dialog('open').dialog('center').dialog('setTitle','新增活动');

        $('#couponRuleDlg').dialog({
            title: '设置优惠券使用规则',
            width: 400,
            height: 400,
            href: '/coupon/couponRule?couponId='+couponId,
            buttons:[{
                text:'确定',
                iconCls:'icon-ok',
                handler:function(){
                    $('#couponRuleDlg').dialog('close');
                    $('#tg').datagrid('reload');
                }
            },{
                text:'取消',
                iconCls:'icon-cancel',
                handler:function(){
                    $('#couponRuleDlg').dialog('close');
                }
            }]
        });
        //$('#fm').form('clear');
    }

    function addCouponSource() {
        //提交form表单
        $('#fm').form('submit', {
            url:'/coupon/addCouponSource.action',
            success: function(data) {
                var data = eval('(' + data + ')');  // change the JSON string to javascript object
                if (data.success) {
                    $('#dd').dialog('close');
                    $('#tg').datagrid('reload');
                    jQuery.messager.show({
                        title:'数据修改成功提示！',
                        msg: '您在 ' + new Date().toLocaleString() + ' 成功更新了一条数据',
                        showType:'show'
                    });
                    couponRuleDlg(data.data);
                }

            },
            error: function() {
                jQuery.messager.show({
                    title:'请求失败！',
                    msg: new Date().toLocaleString() + ' 请求服务器失败',
                    showType:'show'
                });
            }
        });


    }

    $(function(){
        //添加详情查看
        $('#tg').datagrid({
            view: detailview,
            detailFormatter:function(index,row){
                return '<div class="ddv" style="padding:5px 0;"></div>';
            },
            onExpandRow: function(index,row){
                console.log(row);
                var ddv = $(this).datagrid('getRowDetail',index).find('div.ddv');
                ddv.panel({
                    height:80,
                    border:false,
                    cache:false,
                    href:'/coupon/couponSourceDetail.action?id=' + row.id,
                    onLoad:function(){
                        $('#tg').datagrid('fixDetailRowHeight',index);
                    }
                });
                $('#tg').datagrid('fixDetailRowHeight',index);
            }
        });
    })

    //筛选开关
    var i = 1;
    function searchCode() {
        if (i == 1) {
            $("#tg").treegrid('enableFilter');
            i = 0;
        } else {
            $("#tg").treegrid('disableFilter');
            i = 1;
        }
    }
</script>

</body>
</html>