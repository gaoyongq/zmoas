<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zm.mall.dao.wechat.CartDao">
    <resultMap id="CartMap" type="com.zm.mall.domain.wechat.WeChat_cart">
        <result column="cartid" property="cartid" />
        <result column="productid" property="productId" />
        <result column="productName" property="productName" />
        <result column="productImage" property="productImage" />
        <result column="skuid" property="skuid" />
        <result column="skuAttribute" property="skuAttribute" />
        <result column="productNum" property="productNum" />
        <result column="productPrice" property="productPrice" />
        <result column="userCode" property="userCode" />
        <result column="userName" property="userName" />
        <result column="status" property="status" />
    </resultMap>


    <!--查询当前用户的购物车-->
    <select id="selectAllCart" resultMap="CartMap" parameterType="cart" >
        SELECT *
        FROM wechat_cart
        WHERE userCode= #{userCode} AND status=1
        ORDER BY cartid DESC ;

    </select>
    <select id="selectAllCartNum"  resultType="int">
        SELECT SUM(productNum)
        FROM wechat_cart
        WHERE userCode= #{userCode} AND status=1;
    </select>
    <!--更新购物车产品数量-->
    <update id="updateCartCount" parameterType="cart">
        UPDATE wechat_cart SET productNum=#{productNum} WHERE productid=#{productId} AND skuid=#{skuid} AND userCode= #{userCode} AND status=1
    </update>


    <!--加入购物车 检查-->
    <select id="addCartCheck" parameterType="cart" resultType="Integer">
        SELECT count(skuid)
        FROM wechat_cart
        WHERE skuid = #{skuid} AND userCode= #{userCode}  AND status=1
    </select>

    <insert id="addCart" parameterType="cart" >
        INSERT INTO wechat_cart(productId,productName,productImage,sku,skuid,skuAttribute,productNum,productPrice,userCode,userName,weight,status)
        VALUES (#{productId},#{productName},#{productImage},#{sku},#{skuid},#{skuAttribute},#{productNum},#{productPrice},#{userCode},#{userName},#{weight},1);
    </insert>
    <!--加入购物车 加数量-->
    <update id="addCartNum" parameterType="cart">
    UPDATE wechat_cart SET productNum=productNum+#{productNum} WHERE productid=#{productId} AND skuid=#{skuid} AND userCode= #{userCode} AND status=1
</update>
    <select id="selectBuyCart" resultMap="CartMap" >
        SELECT *
        FROM wechat_cart
        WHERE  find_in_set(cartid,#{shopCartStr}) AND status=1

    </select>
    <select id="selectUserAddress" resultType="shippingAddress">
        SELECT s.*
        FROM b2c_shop_shippingaddress s LEFT JOIN b2c_accounts_users a ON a.userid = s.userid
        WHERE a.openId = #{userCode} AND s.state = 1
    </select>
    <update id="updateCartProduct" parameterType="String">
        UPDATE wechat_cart SET status=0 WHERE find_in_set(cartid,#{cartIds})
    </update>

    <select id="getWeChatCart" resultMap="CartMap">
        select * from wechat_cart WHERE skuid = #{skuid} AND userCode= #{userCode}  AND status=1
    </select>

</mapper>