#set($layout = "layout/empty.vm")

<div id="addProdTypeAttr-tabs" class="easyui-tabs" data-options="
        pill:true,
        border:false,
        fit:true,
        justified:true,
        onSelect:function(title,index) {
            if (step != index) {
                $('#addProdTypeAttr-tabs').tabs('select', step);
            } else {
                $('#addProdTypeAttr-tabs').tabs('select', index);
            }
        }
        ">
    <div title="1.填写基本信息 <i class='fa fa-chevron-right fa-lg'></i>" data-options="fit:true" style="padding:10px;">
        <h2>请进行下一步操作</h2>
    </div>

    <div title="2.填写属性及属性值 <i class='fa fa-chevron-right fa-lg'></i>" data-options="">
        <table id="dg" class="easyui-datagrid" data-options="
                singleSelect: true,
                toolbar: '#add-attr-tb',
                pagination:true,
                rownumbers:true,
                fitColumns:true,
                fit:true,
                border:false,
                url: '/business/prodCat/getProdTypeAttrsByTypeId?typeId=$!typeId',
                method: 'get',
                onClickCell: onClickCell,
                onEndEdit: onEndEdit
            ">
            <thead>
            <tr>
                <th data-options="field:'attributeName',width:80,editor:'textbox'">属性名称</th>
                <th data-options="field:'valueStr',width:100,editor:'textbox'">属性值</th>
                <th data-options="field:'usageMode',width:80,
                        formatter:function(value,row){
                            if (value == 0) {
                                return '单选';
                            } else if (value == 1) {
                                return '多选';
                            } else if (value == 2) {
                                return '直接填写';
                            }
                        },
                        editor:{
                            type:'combobox',
                            options:{
                                valueField: 'value',
                                textField: 'label',
                                editable: false,
                                data: [{
                                    label: '单选',
                                    value: '0'
                                },{
                                    label: '多选',
                                    value: '1'
                                },{
                                    label: '直接填写',
                                    value: '2'
                                }],
                                required:true
                            }
                        }">展现模式</th>
            </tr>
            </thead>
        </table>

        <div id="add-attr-tb" style="height:auto">
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="append()">添加扩展属性</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit()">删除</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="accept()">保存</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true" onclick="reject()">回退</a>
            <a href="javascript:void(0)" title="本栏操作均为界面操作，添加的记录点击保存后才能生效。" class="easyui-linkbutton easyui-tooltip" data-options="iconCls:'icon-help',plain:true"></a>
        </div>
        <!---->
    </div>
    <div title="3.添加规格及规格值 <i class='fa fa-check fa-lg'></i>" data-options="" style="padding:10px">
        <h2>请先完成上一步操作，点击下一步继续。</h2>
    </div>
</div>


<script type="text/javascript">
    var editIndex = undefined;
    function endEditing() {
        if (editIndex == undefined){return true}
        if ($('#dg').datagrid('validateRow', editIndex)){
            $('#dg').datagrid('endEdit', editIndex);
            editIndex = undefined;
            return true;
        } else {
            return false;
        }
    }
    function onClickCell(index, field){
        if (editIndex != index){
            if (endEditing()){
                $('#dg').datagrid('selectRow', index)
                        .datagrid('beginEdit', index);
                var ed = $('#dg').datagrid('getEditor', {index:index,field:field});
                if (ed){
                    ($(ed.target).data('textbox') ? $(ed.target).textbox('textbox') : $(ed.target)).focus();
                }
                editIndex = index;
            } else {
                setTimeout(function(){
                    $('#dg').datagrid('selectRow', editIndex);
                },0);
            }
        }
    }
    function onEndEdit(index, row){
        var ed = $(this).datagrid('getEditor', {
            index: index,
            field: 'attributeName'
        });

        //动态添加属性
        //row.productname = $(ed.target).combobox('getText');

        //删除值为null的属性，也就是设为undefined
        for (var r in row) {
            if (row[r] == null) {
                row[r] = undefined;
            }
        }

        jQuery.ajax({
            url: '/business/prodCat/addProdTypeAttr',
            type: 'post',
            data: row,
            dataType: 'json',
            success: function(data) {
                $('#dg').datagrid('reload');

                console.log(data);
            },
            error: function(data) {
                alert("error");
                console.log(data);
            }
        });
    }
    function append(){
        if (endEditing()){

            $('#dg').datagrid('appendRow',{typeId:'$!typeId'});
            editIndex = $('#dg').datagrid('getRows').length-1;
            $('#dg').datagrid('selectRow', editIndex)
                    .datagrid('beginEdit', editIndex);
        }
    }
    function removeit(){
        if (editIndex == undefined){return}
        $('#dg').datagrid('cancelEdit', editIndex)
                .datagrid('deleteRow', editIndex);
        editIndex = undefined;
    }
    function accept(){
        if (endEditing()){
            $('#dg').datagrid('acceptChanges');
        }
    }
    function reject(){
        $('#dg').datagrid('rejectChanges');
        editIndex = undefined;
    }
</script>