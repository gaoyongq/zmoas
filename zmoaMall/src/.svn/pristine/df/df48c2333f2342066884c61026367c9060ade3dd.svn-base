#set($layout = "layout/empty.vm")
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>微信订单列表</title>
    <link rel="stylesheet" type="text/css" href="/js/jeasyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="/js/jeasyui/themes/color.css">
    <link rel="stylesheet" type="text/css" href="/js/jeasyui/themes/default/easyui.css">
    <script type="text/javascript" src="/js/jeasyui/jquery.min.js"></script>
    <script type="text/javascript" src="/js/jeasyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/js/jeasyui/plugins/datagrid-filter.js"></script>
    <script type="text/javascript" src="/js/jeasyui/plugins/datagrid-detailview.js"></script>
    <script type="text/javascript" src="/js/jeasyui/plugins/datagrid-cellediting.js"></script>
    <script type="text/javascript" src="/js/jeasyui/locale/easyui-lang-zh_CN.js"></script>
</head>
<body>

<table id="dg" class="easyui-datagrid" data-options="
        url: '/business/yyOrderList',
        toolbar:'#tb',
        fitColumns:true,
        title:'微信预约订单列表',
        border:false,
        fit:true,
        rownumbers: true,
        pagination: true,
        remoteFilter: true,
        pageSize:20,
        singleSelect:true,
        idField: 'orderId',
        onAfterEdit:updateOrderStatus
    ">

    <thead>
    <tr>
        <th data-options="field:'ck',checkbox:true" width="5%"></th>
        <th data-options="field:'orderCode',align:'left'" width="15%">订单号</th>
        <th data-options="field:'buyerName',align:'left'" width="15%">用户名</th>
        <th data-options="field:'buyerCellPhone',align:'left'" width="10%">用户联系方式</th>
        <th data-options="field:'shipName',align:'left'" width="5%">收货人</th>
        <th data-options="field:'shippingStatus',align:'left',formatter:shippingStatusFormatter,
            editor:{
                type:'combobox',
                options:{
                    valueField:'value',
                    textField:'text',
                    panelHeight:'auto',
                    editable:false,
                    method:'get',
                    data:[{
                        text: '已完成',
                        value: '2'
                    },{
                        text: '已发货',
                        value: '1'
                    },{
                        text: '未发货',
                        value: '0'
                    }],
                    required:true
                }
            }" width="7%">发货状态</th>
        <th data-options="field:'orderCheckStatus',align:'left',formatter:checkStatusFormatter,
            editor:{
                type:'combobox',
                options:{
                    valueField:'value',
                    textField:'text',
                    panelHeight:'auto',
                    editable:false,
                    method:'get',
                    data:[{
                        text: '已审核',
                        value: '1'
                    },{
                        text: '未审核',
                        value: '0'
                    }],
                    required:true
                }
            }" width="7%">审核状态</th>
        <th data-options="field:'orderStatus',align:'left',formatter:orderStatusFormatter" width="7%">订单状态</th>
        <th data-options="field:'orderTotal',align:'right',formatter:priceFormatter" width="10%">订单总额</th>
        <th data-options="field:'createdDate',align:'right',formatter:dateFormatter" width="15%">下单时间</th>
    </tr>
    </thead>
</table>

<!-- toolbar -->
<div id="tb" style="padding:2px 5px;">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-search" style="width:100px" onclick="searchCode();">搜索筛选</a>
    &nbsp;&nbsp;
</div>


<script>
    function updateOrderStatus(index,row,changes) {
        var key = '';

        for (var n in changes) {
            key = n;
        }
        jQuery.ajax({
            url: "/business/updateOrderStatus",
            type: "post",
            data: {"orderId":row.orderId, "key":key, "value":changes[key]},
            dataType: "json",
            success: function (data) {
                if(data==1){
                    jQuery.messager.show({
                        title:'数据更新提示！',
                        msg:'状态已更新',
                        timeout:3000,
                        showType:'slide'
                    });
                    data=0;
                }else {

                }
            }
        });
    }

    $(function(){
        $('#dg').datagrid('enableCellEditing').datagrid('gotoCell', {
            index: 0,
            field: 'usedTime'
        });
    });

    $(function(){
        $('#dg').datagrid({
            view: detailview,
            detailFormatter:function(index,row){
                return '<div style="padding:2px"><table class="ddv"></table></div>';
            },
            onExpandRow: function(index,row){
                var ddv = $(this).datagrid('getRowDetail',index).find('table.ddv');
                ddv.datagrid({
                    url:'/business/wxyyOrderDetail?orderId='+row.orderId,
                    fitColumns:true,
                    singleSelect:true,
                    rownumbers:true,
                    loadMsg:'',
                    height:'auto',
                    columns:[[
                        {field:'name',title:'商品名称',width:10},
                        {field:'sku',title:'编号',width:10},
                        {field:'shipmentQuantity',title:'数量',width:10},
                        {field:'sellPrice',title:'单价',width:10,formatter:priceFormatter},
                        {field:'totalPrice',title:'产品金额',width:10,formatter:totalPriceFormatter}
                    ]],
                    onResize:function(){
                        $('#dg').datagrid('fixDetailRowHeight',index);
                    },
                    onLoadSuccess:function(){
                        setTimeout(function(){
                            $('#dg').datagrid('fixDetailRowHeight',index);
                        },0);
                    }
                });
                $('#dg').datagrid('fixDetailRowHeight',index);
            }
        });
    });


    function checkStatusFormatter(value, row, index) {
        if (value == 0) {
            return '<span style="color:blue;">[未审核]</span>';
        } else if (value == 1) {
            return '<span style="color:green;">[已审核]</span>';
        }
    }

    function orderStatusFormatter(value, row, index) {
        if (value == 0) {
            return '<span style="color:blue;">[等待付款]</span>';
        } else if (value == -1) {
            return '<span style="color:black;">[已取消]</span>';
        } else if (value == 2) {
            return '<span style="color:green;">[已完成]</span>';
        }
    }

    function shippingStatusFormatter(value, row, index) {
        if (value == 0) {
            return '<span style="color:blue;">[未发货]</span>';
        } else if (value == 1) {
            return '<span style="color:green;">[已发货]</span>';
        } else if (value == 2) {
            return '<span style="color:green;">[已完成]</span>';
        }
    }

    function priceFormatter(value,row,index) {
        return '&yen;' + value.toFixed(2);
    }

    function totalPriceFormatter(value,row,index){
        return '&yen;' + (row.shipmentQuantity * row.sellPrice).toFixed(2);
    }

    function dateFormatter(value,row,index){
        return new Date(value).toLocaleString();
    }

    //筛选开关
    var i = 1;
    function searchCode() {
        if (i == 1) {
            $("#dg").datagrid('enableFilter',[
                    {
                        field: 'orderCheckStatus',
                        type: 'combobox',
                        options: {
                            panelHeight: 'auto',
                            data: [{ value: '1', text: '已审核' }, { value: '0', text: '未审核' }],
                            onChange: function (value) {
                                $("#dg").datagrid('addFilterRule', {
                                    field: 'orderCheckStatus',
                                    op: 'equal',
                                    value: value,
                                    type: 'number'
                                });
                                $("#dg").datagrid('doFilter');
                            }
                        }
                    }
                , {
                        field: 'shippingStatus',
                        type: 'combobox',
                        options: {
                            panelHeight: 'auto',
                            data: [{ value: '0', text: '未发货' }, { value: '2', text: '已完成' }, { value: '1', text: '已发货' }],
                            onChange: function (value) {
                                $("#dg").datagrid('addFilterRule', {
                                    field: 'shippingStatus',
                                    op: 'equal',
                                    value: value,
                                    type: 'number'
                                });
                                $("#dg").datagrid('doFilter');
                            }
                        }
                    }
                    ]);
            i = 0;
        } else {
            $("#dg").datagrid('disableFilter');
            i = 1;
        }
    }
</script>

</body>
</html>